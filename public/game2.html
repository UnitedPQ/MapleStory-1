<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>小朋友下樓梯</title>
    <style>
            * { padding: 0; margin: 0; }
            canvas { background: #eee; display: block; margin: 0 auto; }

    </style>
    <script>
        var images = new Array(8);
        for(var i = 0;i<images.length ;i++){
            images[i]= new Image();
            images[i].src="img/pic"+(1+Math.floor(i/4))+"_"+(1+i%4)+"f.png";
            console.log(images[i]);
        }
    
    
    
    
    </script>
  
    
    
    
    
    
    
</head>
<body>
    
    
    <canvas id="myCanvas" width="800" height="600"></canvas>
   
    <script>
    
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    
    
    var floorN = 10;
    var floors = [];
    for(var i = 0; i<floorN ; i++){
        floors[i]={x :0, y:0 , status : 0}
    }
    for(var i = 0;i <floorN;i++){
        floors[i].x= Math.floor( Math.random()*canvas.width + 1);
        floors[i].y= Math.floor( Math.random()*canvas.height + 1);
    }
    
    
   /////////////picture///////////////// 
    var x =200;
    var y = 200;
    var picStatus = 0 ; // 0 represents no movement and 1~3 represents movement 
    var dx_m = 5 ; //pic's movemoent  
    var dy_p = 2;
    var img = new Image();
    //img.src = "img/pic1_1f.png";
    img.src = images[0].src;
    img.onload = function(){ 
        ctx.drawImage(img,x,y,img.width/4,img.height / 4); 
            }   
    var picHeight = img.height / 4;
    var picWidth =img.width /4;        
    ////////////////////////////////////
    ////////////others/////////////////
    var dy = -2;
    
    var floorWidth = 100;
    var floorHeight = 10;
    var rightPressed = false;
    var leftPressed = false; 
    var downPressed = false;
    var score = 0;
    //////////////////////////////////


    /*function drawBall() {
        ctx.beginPath();
        ctx.arc(x,y,ballRadius,0,Math.PI*2);
        ctx.fillStyle = "red";
        ctx.fill();
        ctx.closePath();
    }*/
    function drawFloor(i){
            ctx.beginPath();
            ctx.rect(floors[i].x , floors[i].y , floorWidth,floorHeight);
            ctx.fillStyle = "#0095DD";
            ctx.fill();
            ctx.closePath();
        
    }
    function picTouchFloor(){//先不考慮
        
        for(var i=0; i<floorN ; i++){
            var F = floors[i];
            if( y + picHeight >=F.y && y + picHeight < F.y + floorHeight && x+picWidth/2 >F.x && x + picWidth/2 < F.x + floorWidth){
            y+=dy ;
            floors[i].status = 1;}
            //else{y-=dy;} 
            else{
                floors[i].status = 0;
            }
        }       
            
    }
    function sum(){
        var sum = 0;
        for(var i = 0; i<floorN; i++){
            sum += floors[i].status;
        }
        return sum;
    }
    function getScore(){
        if(floors[0].y <= 0){
            score +=10;
            console.log("get in");
            console.log("score:" + score);
        }
        //return score;
    }
    function drawScore() {
        ctx.font = "16px Arial";
        ctx.fillStyle = "black";
        ctx.fillText("Score: "+score, 8, 20);
}
    /*function preloadImg(Image){
        var img = new Image();
        img.src = Image;
    }*/
    function init(){
        floors[0].x = 400;
        floors[0].y = 400;
        x = floors[0].x + floorWidth/2 - picWidth/2;
        y = floors[0].y- picHeight;
        //drawBall();
        for( var i = 0; i< floorN; i++){
            drawFloor(i);}
    }
    
    function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        img.src = images[0].src;
        drawScore();
        picTouchFloor();
        for(var i = 0 ; i < floorN; i++){
            if (floors[i].y > 0){
                floors[i].y += dy ;
                drawFloor(i);
        }
        else{
            ctx.clearRect(floors[i].x,floors[i].y,floors[i].x+floorWidth,floors[i].y+floorHeight);
            floors[i].x = Math.floor( Math.random()*canvas.width + 1);
            floors[i].y = canvas.height;
            drawFloor(i);
            picTouchFloor();

            
            //y_f[i] = Math.floor( Math.random()*canvas.height + 1);
           
            
        }}
        if(!sum()){
            y+= dy_p;
        }
       
        if(leftPressed == true && x>0 ){
            if(!sum()){
                //img.src = "img/pic2_2f.png";
                img.src = images[5].src;
                img.onload;
            }else{if(picStatus%4 == 0){
                //img.src = "img/pic2_2f.png"; 
                img.src = images[5].src;
                picStatus += 1;
            }else if(picStatus%4 == 1){
                //img.src = "img/pic2_3f.png";
                img.src = images[6].src;
                picStatus += 1;
            }else if(picStatus%4 == 2){
                //img.src = "img/pic2_4f.png";
                img.src = images[7].src;
                picStatus += 1;
            }else{
                //img.src = "img/pic2_1f.png"
                img.src = images[4].src;
                picStatus = 0;
            }
            img.onload;}
            x -= dx_m; 
            }else if(rightPressed == true && x<canvas.width - picWidth){
            if(!sum()){
                //img.src = "img/pic1_2f.png";
                img.src = images[1].src;
                img.onload;
            }else{if(picStatus%4 == 0){
                //img.src = "img/pic1_2f.png"; 
                img.src = images[1].src;
                picStatus += 1;
            }else if(picStatus%4 == 1){
                //img.src = "img/pic1_3f.png";
                img.src = images[2].src;
                picStatus += 1;
            }else if(picStatus%4 == 2){
                //img.src = "img/pic1_4f.png";
                img.src = images[3].src;
                picStatus += 1;
            }else{
                //img.src = "img/pic1_1f.png"
                img.src = images[0].src;
                picStatus = 0;
            }
            img.onload; }
          
            x += dx_m;
        }else{
            //img.src = "img/pic1_1f.png";
            img.src = images[0].src;
            img.onload;
                }
        if(downPressed == true ){
            if( sum()==0){
                   
                   y += dy_p;
               }
                     
       } 
       if ( y + picHeight >= canvas.height | y  <= 0){
           alert("game over");
           document.location.reload();
       }//else{
         //  drawBall();
       //}
       getScore();
       drawScore();
       advance();
       
       
       
        requestAnimationFrame(draw);
    }
    document.addEventListener("keydown",keyDownHandler,false);
    document.addEventListener("keyup",keyUpHandler,false);
    function keyDownHandler(e){
        if(e.keyCode ==39){
            rightPressed = true;
        }
        else if(e.keyCode ==37){
            leftPressed = true;
        }
        else if(e.keyCode == 40 ){
            downPressed = true;
            e.preventDefault();
        }
    }
    function keyUpHandler(e){
        if(e.keyCode ==39){
            rightPressed = false;
        }
        else if(e.keyCode ==37){
            leftPressed = false;
        }
        else if(e.keyCode == 40 ){
            downPressed = false;
            e.preventDefault();
        }
    }
    function advance(){
        if (score>=20){
            dy =-( Math.pow(score,0.3));
            console.log(score);
        }
      
       
    }
    init();
    draw();



    
    
    
    
    
    
    
    </script>
    


</body>
</html>
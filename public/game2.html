<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>小朋友下樓梯</title>
    <style>
            * { padding: 0; margin: 0; }
            canvas { background: #eee; display: block; margin: 0 auto; }

    </style>
    <script>
        var images = new Array(8);
        for(var i = 0;i<images.length ;i++){
            images[i]= new Image();
            images[i].src="img/pic"+(1+Math.floor(i/4))+"_"+(1+i%4)+"f.png";
            console.log(images[i]);
        }
        var images_f = new Array(1);
        images_f[0] = new Image();
        images_f[0].src = "img/f1f.png";   
        console.log(images_f[0]);
        var images_m = new Array(1);
        images_m[0] = new  Image();
        images_m[0].src = "img/red_mf.png"; 
        console.log(images_m[0]);
    
    
    
    
    </script>
  
    
    
    
    
    
    
</head>
<body>
    
    
    <canvas id="myCanvas" width="800" height="600"></canvas>
   
    <script>
    
    var canvas = document.getElementById("myCanvas");
    var ctx = canvas.getContext("2d");
    
    
    var floorN = 10;
    var floors = [];
    for(var i = 0; i<floorN ; i++){
        floors[i]={x :0, y:0 , status : 0 , feature : 0 , medicine : 0} //status represents whether character touch the floor
    }                                                    //feature represents what kinds of floor it is 
    for(var i = 0;i <floorN;i++){
        floors[i].x= Math.floor( Math.random()*canvas.width + 1);
        floors[i].y= Math.floor( Math.random()*canvas.height + 1);
    }
    
    
   /////////////character's picture///////////////// 
    var picWidth = 81.5;
    var picHeight = 89.5;
    var x =200;
    var y = 200;
    var picStatus = 0 ; // 0 represents no movement and 1~3 represents movement 
    var dx_m = 5 ; //pic's movemoent  
    var dy_p = 2;
    var img = new Image();
    img.src = images[0].src;
    img.onload = function(){
        picHeight = img.height / 4;
        picWidth =img.width /4;   
        ctx.drawImage(img,x,y,picWidth,picHeight); 
            }   
          
    ///////////////////////////////////
    //////////feature floor/////////////
    var img_f = new Image();
    img_f.src = images_f[0].src;
    img_f.onload = function(i){
            ctx.drawImage(img_f,floors[i].x,floors[i].y,floorWidth,floorHeight); 
        }


    ///////////////////////////////////
    //////////medicine/////////////////
    
    var img_m = new Image();
    img_m.src = images_m[0].src;
    var img_m_size = 30;
    img_m.onload = function(i){
        ctx.drawImage(img_m,floors[i].x,floors[i].y-img_m_size,img_m_size,img_m_size);
    }
    var Medicine = {
        createNew: function(i){
            var medicine = {};
            medicine.status = 0;//status represents different medicines 
            medicine.x = floors[i].x;
            medicine.y = floors[i].y-img_m_size;
            medicine.onload = function(i){
                ctx.drawImage(img_m,floors[i].x,floors[i].y-img_m_size,img_m_size,img_m_size);
            }
               
             
            return medicine;           　　　　　　
        　　　　}
        　　};
    var med = Medicine.createNew(0);
    
    ///////////////////////////////////
   
    ////////////others/////////////////
    var t = 0;
    var dt = 1;
    var dy = -2;
    var floorWidth = 100;
    var floorHeight = 10;
    var rightPressed = false;
    var leftPressed = false; 
    var downPressed = false;
    var score = 0;
    var lives = 3;
    //////////////////////////////////


    /*function drawBall() {
        ctx.beginPath();
        ctx.arc(x,y,ballRadius,0,Math.PI*2);
        ctx.fillStyle = "red";
        ctx.fill();
        ctx.closePath();
    }*/
    function drawFloor(i){
            
            if(floors[i].feature ==0){
                ctx.beginPath();
                ctx.rect(floors[i].x , floors[i].y , floorWidth,floorHeight);
                ctx.fillStyle = "#0095DD";
                ctx.fill();
                ctx.closePath();
            }else{

                img_f.onload(i);
            }
            
            
        
    }
    //function 裡面 新增class裡面的資訊會有問題
    function drawMedicine(i){
       if(floors[i].medicine == 1 ){//
           med.onload(i);                  // med.status means that medicine appears first or appears long time
          // med.status = 1;g
       }else{
        ctx.clearRect(med.x,med.y,med.x+img_m_size,med.y+img_m_size);  
        floors[i].medicine = 0;
       }

       


    }

    
    function picTouchFloor(){//先不考慮
        
        for(var i=0; i<floorN ; i++){
            med = Medicine.createNew(i);
            var F = floors[i];
            if( y + picHeight >=F.y && y + picHeight < F.y + floorHeight && x+picWidth/2 >F.x && x + picWidth/2 < F.x + floorWidth){
            y+=dy ;
            floors[i].status = 1;//character touch the floor
            if(floors[i].feature == 1){
                t=0;
                lives--;
                floors[i].feature = 1.5;}
             else if (floors[i].feature == 1.5){
                    t+=dt;
                    if(t==50){
                        lives --;
                        t=0;
                    }
                } 
            if(floors[i].medicine ==1 && x+picWidth/2>=med.x && x+picWidth/2<=med.x+img_m_size ){
                ctx.clearRect(med.x,med.y,med.x+img_m_size,med.y+img_m_size); 
                lives++;
                floors[i].medicine = 0;
            }               
            
            }
            //else{y-=dy;} 
            else{
                floors[i].status = 0;
            }
        }       
            
    }
    function sum(){
        var sum = 0;
        for(var i = 0; i<floorN; i++){
            sum += floors[i].status;
        }
        return sum;
    }
    function getScore(){
        if(floors[0].y <= 0){
            score +=10;
            console.log("get in");
            console.log("score:" + score);
        }
        //return score;
    }
    function drawScore() {
        ctx.font = "16px Arial";
        ctx.fillStyle = "black";
        ctx.fillText("Score: "+score, 8, 20);
}
    function drawLives() {
        ctx.font = "16px Arial";
        ctx.fillStyle = "#0095DD";
        ctx.fillText("Lives: "+lives, canvas.width-65, 20);
}
    /*function preloadImg(Image){
        var img = new Image();
        img.src = Image;
    }*/
    function init(){
        floors[0].x = 400;
        floors[0].y = 400;
        x = floors[0].x + floorWidth/2 - picWidth/2;
        y = floors[0].y- picHeight;
        //drawBall();
        for( var i = 0; i< floorN; i++){
            drawFloor(i);}
    }
    
    function draw(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        img.onload();
        drawScore();
        picTouchFloor();
        for(var i = 0 ; i < floorN; i++){
            if (floors[i].y > 0){
                floors[i].y += dy ;
                drawFloor(i);
                if(floors[i].medicine==1){
                    drawMedicine(i);
                }
        }
        else{
            floors[i].medicine = 0;
            drawMedicine(i);
            ctx.clearRect(floors[i].x,floors[i].y,floors[i].x+floorWidth,floors[i].y+floorHeight);
            floors[i].x = Math.floor( Math.random()*canvas.width + 1);
            floors[i].y = canvas.height;
            floors[i].feature = Math.round(Math.random()*0.7); //0 or 1 determine what kinds of floor it is
            if(!floors[i].feature){floors[i].medicine = Math.round(Math.random()*0.65);}
            drawFloor(i);
            picTouchFloor();
            drawMedicine(i);
            
            

            
            //y_f[i] = Math.floor( Math.random()*canvas.height + 1);
           
            
        }}
        if(!sum()){
            y+= dy_p;
        }
       
        if(leftPressed == true && x>0 ){
            if(!sum()){
                //img.src = "img/pic2_2f.png";
                img.src = images[5].src;
                img.onload();
            }else{if(picStatus%4 == 0){
                //img.src = "img/pic2_2f.png"; 
                img.src = images[5].src;
                picStatus += 1;
            }else if(picStatus%4 == 1){
                //img.src = "img/pic2_3f.png";
                img.src = images[6].src;
                picStatus += 1;
            }else if(picStatus%4 == 2){
                //img.src = "img/pic2_4f.png";
                img.src = images[7].src;
                picStatus += 1;
            }else{
                //img.src = "img/pic2_1f.png"
                img.src = images[4].src;
                picStatus = 0;
            }
            img.onload();}
            x -= dx_m; 
            }else if(rightPressed == true && x<canvas.width - picWidth){
            if(!sum()){
                //img.src = "img/pic1_2f.png";
                img.src = images[1].src;
                img.onload();;
            }else{if(picStatus%4 == 0){
                //img.src = "img/pic1_2f.png"; 
                img.src = images[1].src;
                picStatus += 1;
            }else if(picStatus%4 == 1){
                //img.src = "img/pic1_3f.png";
                img.src = images[2].src;
                picStatus += 1;
            }else if(picStatus%4 == 2){
                //img.src = "img/pic1_4f.png";
                img.src = images[3].src;
                picStatus += 1;
            }else{
                //img.src = "img/pic1_1f.png"
                img.src = images[0].src;
                picStatus = 0;
            }
            img.onload();; }
          
            x += dx_m;
        }else{
            //img.src = "img/pic1_1f.png";
            img.src = images[0].src;
            img.onload();
                }
        if(downPressed == true ){
            if( sum()==0){
                   
                   y += dy_p;
               }
                     
       } 
       if ( y + picHeight >= canvas.height | y  <= 0 | lives==0){
           alert("game over");
           document.location.reload();
       }//else{
         //  drawBall();
       //}
       getScore();
       drawScore();
       drawLives();
       advance();
       
       
       
        requestAnimationFrame(draw);
    }
    document.addEventListener("keydown",keyDownHandler,false);
    document.addEventListener("keyup",keyUpHandler,false);
    /*document.addEventListener("touchstart",handleStart,false);
    document.addEventListener("touchmove",handleMove,false);
    document.addEventListener("touchend",handleEnd,false);*/
    function keyDownHandler(e){
        if(e.keyCode ==39){
            rightPressed = true;
        }
        else if(e.keyCode ==37){
            leftPressed = true;
        }
        else if(e.keyCode == 40 ){
            downPressed = true;
            e.preventDefault();
        }
    }
    function keyUpHandler(e){
        if(e.keyCode ==39){
            rightPressed = false;
        }
        else if(e.keyCode ==37){
            leftPressed = false;
        }
        else if(e.keyCode == 40 ){
            downPressed = false;
            e.preventDefault();
        }
    }
    /*function handleStart(e){

    }
    function handleMove(e){
        e.preventDefault();

    }
    function handleEnd(e){}
    */
    function advance(){
        if (score>=20){
            dy =-( Math.pow(score,0.3));
            console.log(score);
        }
      
       
    }
    init();
    draw();



    
    
    
    
    
    
    
    </script>
    


</body>
</html>